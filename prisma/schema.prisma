generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("POSTGRES_PRISMA_URL")
}

model CreditLog {
  id                String     @id @default(uuid())
  userId            String
  creditType        String     @default("normal") // 'normal' or 'radio'
  amount            Int
  balanceAfter      Int
  radioBalance      Int         @default(0)
  description       String
  relatedEntityId   String?
  relatedEntityType String?
  createdAt         DateTime   @default(now())
  User              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Gallery {
  id        String @id @default(uuid())
  userId    String
  audioLink String
  isPaid    String
  User      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NewsletterLog {
  id             String   @id @default(uuid())
  subject        String
  content        String
  userGroup      String
  sentById       String
  recipientCount Int
  failureCount   Int      @default(0)
  createdAt      DateTime @default(now())
  User           User     @relation(fields: [sentById], references: [id])
}

model Payment {
  id              String   @id @default(uuid())
  userId          String
  stripePaymentId String
  amount          Float
  currency        String   @default("USD")
  status          String
  paymentMethod   String?
  description     String?
  metadata        Json?
  createdAt       DateTime @default(now())
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PricingPlan {
  id            String   @id @default(uuid())
  stripePriceId String   @unique
  name          String
  description   String
  priceMonthly  Float
  credits       Int
  maxDownloads  Int
  features      String[]
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime
}

model Song {
  id               String    @id @default(uuid())
  userId           String
  title            String?
  prompt           String
  lyrics           String?
  audioUrl         String
  videoUrl         String?
  thumbnailUrl     String?
  duration         Int
  creditsUsed      Int
  isLyricsPurchased Boolean @default(false)
  salePrice        Float?
  isPublic         Boolean   @default(false)
  isForSale       Boolean   @default(false)
  tags             String[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  alternativeSongs Json?
  completedAt      DateTime?
  generationId     String?
  generationTime   Int?
  mood             String?
  provider         String?
  startedAt        DateTime?
  style            String?
  taskId           String?
  tempo            String?
  quality          String?   @default("pending")
  User             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  shares           SongsOnShares[]
  purchases       SongPurchase[]
}
model Media {
  id               String    @id @default(uuid())
  userId           String
  title            String?
  description      String?
  
  // Common fields for both image and video
  mediaType        String    // 'image' or 'video'
  fileUrl          String?   // Final URL of the generated media
  thumbnailUrl     String?   // URL of the thumbnail (for video)
  
  // Video specific fields (from Sora-like API response)
  taskId           String?   // Task ID for generation tracking
  status           String?   // queued, processing, completed, failed
  progress         Int?      // 0-100
  size             String?   // e.g., "1024x1808"
  duration         Int?      // Duration in seconds
  quality          String?   // e.g., "standard"
  
  // Image specific fields (from DALL-E like API response)
  model            String?   // Model used for generation
  usage            Json?     // Token usage information
  
  // Common metadata
  width            Int?      // Width in pixels
  height           Int?      // Height in pixels
  fileSize         Int?      // File size in bytes
  mimeType         String?   // MIME type of the file
  
  // Sharing and visibility
  isPublic         Boolean   @default(false)
  isForSale        Boolean   @default(false)
  salePrice        Float?
  creditsUsed      Int       @default(400) 
  
  // Timestamps
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  completedAt      DateTime?
  
  // Relations
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  shares           MediaOnShares[]
  purchases        MediaPurchase[]
}

model MediaPurchase {
  id           String   @id @default(uuid())
  userId       String
  mediaId      String
  price        Float
  purchasedAt  DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  media        Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)
}


model SongPurchase {
  id        String   @id @default(uuid())
  userId    String
  songId    String
  mediaId   String?
  price     Float
  purchasedAt DateTime @default(now())

  User      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  Song      Song   @relation(fields: [songId], references: [id], onDelete: Cascade)
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @unique
  stripeSubscriptionId String
  stripePriceId        String
  planName             String
  status               SubscriptionStatus
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  User                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Thumbnail {
  id             Int    @id @default(autoincrement())
  ThumbnailImage String
}

model User {
  id                String               @id @default(uuid())
  fullName          String
  email             String               @unique
  
  // Relations for Referral system
  referredBy        Referral[]           @relation("Referee")
  referredUsers     Referral[]           @relation("Referrer")
  password          String
  role              Role                 @default(Basic)
  credits           Int                  @default(50) // Normal credits
  radioCredits      Int                  @default(0)  // Radio-specific credits
  totalCreditsUsed  Int                  @default(0)
  maxMonthlyCredits Int                  @default(0)
  max_download      Int                  @default(0)
  totalDownloads    Int                  @default(0)
  stripeCustomerId  String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  isVerified        Boolean              @default(false)
  isSuspended       Boolean              @default(false)
  lastLoginAt       DateTime?
  radioSubscriptionExpiresAt DateTime?
  isRadioSubscribed        Boolean   @default(false)
  lastRadioCreditUpdate    DateTime?
  totalEarnedCredits       Int       @default(0) // Total credits earned from rewards
  referralCode            String?   @unique // For referral program


  CreditLog         CreditLog[]
  Gallery           Gallery[]
  NewsletterLog     NewsletterLog[]
  Payment           Payment[]
  Song              Song[]
  Media             Media[]
  Subscription      Subscription?
  Verification      Verification?
  videoLinks        videoLinks[]
  createdShares     Share[]              @relation("CreatedShares")
  sharesReceived    UsersOnShares[]
  purchases         SongPurchase[]
  creditsRemaining  Int                  @default(0)
  subscriptionPlans UserSubscription[]
  mediaPurchases    MediaPurchase[]
  rewards           Reward[]        @relation("UserRewards")
}

model Reward {
  id              String   @id @default(uuid())
  userId          String
  type            String   // 'listening', 'referral', 'promo'
  points          Int      // Points earned
  description     String
  status          RewardStatus @default(active)
  expiresAt       DateTime?  // When the points expire
  metadata        Json?      // Additional data like song ID, referral details
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation("UserRewards", fields: [userId], references: [id], onDelete: Cascade)
}
enum RewardStatus {
  active
  used
  expired
}

enum ReferralStatus {
  pending
  completed
  expired
}

model Referral {
  id           String         @id @default(uuid())
  referrerId   String
  refereeId    String
  rewardPoints Int
  status       ReferralStatus @default(pending)
  createdAt    DateTime       @default(now())

  referrer     User @relation("Referrer", fields: [referrerId], references: [id])
  referee      User @relation("Referee", fields: [refereeId], references: [id])
}


model UserSubscription {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  planId        String
  plan          UserSubscriptionPlan @relation(fields: [planId], references: [id])
  startDate     DateTime @default(now())
  expiryDate    DateTime
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, planId, isActive])
  @@index([userId, isActive])
}

model UserSubscriptionPlan {
  id            String             @id @default(uuid())
  name          String             @unique
  features      String[]
  durationDays  Int                @default(30)
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  subscriptions UserSubscription[]
}

model Verification {
  id          String           @id @default(uuid())
  userId      String           @unique
  code        String
  type        VerificationType
  expiresAt   DateTime
  isUsed      Boolean          @default(false)
  redirectUrl String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @default(now())
  token       String?
  User        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model videoLinks {
  id            String  @id @default(uuid())
  userId        String
  isLive        Boolean @default(true)
  videoLink     String  @unique
  title         String
  thumbnailLink String
  User          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Share {
  id            String   @id @default(uuid())
  name          String?
  isPublic      Boolean  @default(false)
  shareableLink String   @unique @default(uuid())
  sharedById    String
  sharedBy      User     @relation("CreatedShares", fields: [sharedById], references: [id], onDelete: Cascade)
  songs         SongsOnShares[]
  media         MediaOnShares[]
  sharedWith    UsersOnShares[]
  createdAt     DateTime @default(now())
}

model SongsOnShares {
  shareId   String
  share     Share    @relation(fields: [shareId], references: [id], onDelete: Cascade)
  songId    String
  song      Song     @relation(fields: [songId], references: [id], onDelete: Cascade)
  addedAt   DateTime @default(now())

  @@id([shareId, songId])
}

model MediaOnShares {
  id        String   @id @default(uuid())
  mediaId   String
  shareId   String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  media     Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  share     Share    @relation(fields: [shareId], references: [id], onDelete: Cascade)
}


model UsersOnShares {
    shareId String
    share   Share @relation(fields: [shareId], references: [id], onDelete: Cascade)
    userId  String
    user    User @relation(fields: [userId], references: [id], onDelete: Cascade)
    sharedAt DateTime @default(now())

    @@id([shareId, userId])
}

enum Role {
  Admin
  Premium
  Pro
  Starter
  Basic
}

enum SubscriptionStatus {
  Active
  Canceled
  Expired
  Paused
  Trialing
}

enum VerificationType {
  SIGNUP
  PASSWORD_RESET
}